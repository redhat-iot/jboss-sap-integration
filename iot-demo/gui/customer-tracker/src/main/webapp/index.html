<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>IoT Demo</title>
<script type="text/javascript" src="js/jquery-1.8.3.js"></script>
<script type="text/javascript" src="js/socket.io.js"></script>
</head>
<script type="text/javascript">

  var socket = io.connect('http://localhost:5000');
    socket.on('connect', function () {
      socket.on('mqtt', function (msg) {
    	  updatePage(msg.topic, msg.payload);
    	  if (msg.topic=="salesnotification"){
    		  sendAlert(msg.payload);
    	  }
     });
     socket.emit('subscribe',{topic:'salesnotification'});
     socket.emit('subscribe',{topic:'customermove'});
     socket.emit('subscribe',{topic:'customerexit'});
    });
    
    function sendAlert(topic, payload) {
    	var obj = JSON.parse(payload);
    	var id = obj['id'];
    	var x = obj['x'];
    	var y = obj['y'];
    	
    	customAlert("Customer "+id+" may need assistance at x="+x+"y="+y,"15000");
    	
    }
    
    function customAlert(msg,duration) {
	     var styler = document.createElement("div");
	     styler.setAttribute("style","border: solid 5px Red;width:auto;height:auto;top:50%;left:40%;background-color:#444;color:Silver");
	     styler.innerHTML = "<h1>"+msg+"</h1>";
	     setTimeout(function()
	     {
	       styler.parentNode.removeChild(styler);
	     },duration);
	     document.body.appendChild(styler);
    }
    
	function updatePage(topic, payload) {
		if (topic=="customermove"  ||
		    topic=="customerexit"){
			
			var parsed_payload = JSON.parse(JSON.stringify(payload.substring(payload.indexOf("{",0))));
			
			var key = getKey(parsed_payload);
			
			//Delete from map if the customer has left the store
			if ( topic=="customerexit") {
				var exit_key = getCustomerExitingKey(parsed_payload);
				localStorage.removeItem(exit_key);
			}else{
				localStorage.setItem(key,parsed_payload);
			}
			
			//document.body.innerHTML = '';
			//get a reference to the canvas
			var canvas=document.getElementById('canvas');
			var ctx = canvas.getContext('2d');
			// Store the current transformation matrix
			ctx.save();

			// Use the identity matrix while clearing the canvas
			ctx.setTransform(1, 0, 0, 1, 0, 0);
			ctx.clearRect(0, 0, canvas.width, canvas.height);

			// Restore the transform
			ctx.restore();

			for (var i = 0; i < localStorage.length; i++){
			    var item = localStorage.getItem(localStorage.key(i));
			    var obj = JSON.parse(JSON.stringify(item));
				var x = getX(obj);
				var y = getY(obj);	

				//draw a circle
				ctx.beginPath();
				ctx.arc(Number(x)+getRandomInt(10, 450), Number(y)+getRandomInt(10, 250), 5, 0, Math.PI*2, true); 
				ctx.closePath();
				ctx.fill();
			}
			
			function getKey(payload){
				return parsed_payload.substring(parsed_payload.indexOf("'id': ")+6, parsed_payload.indexOf(", 'ts'"));
			}
			
			function getCustomerExitingKey(payload){
				return parsed_payload.substring(parsed_payload.indexOf(": ")+2);
			}
			
			function getX(payload){
				return parsed_payload.substring(parsed_payload.indexOf("'x': ")+4, parsed_payload.indexOf(", 'id'")).trim();
			}
			
			function getY(payload){
				return parsed_payload.substring(parsed_payload.indexOf("'y': ")+4, parsed_payload.indexOf(", 'x'")).trim();
			}
			
			/**
			 * Returns a random integer between min (inclusive) and max (inclusive)
			 * Using Math.round() will give you a non-uniform distribution!
			 */
			function getRandomInt(min, max) {
			    return Math.floor(Math.random() * (max - min + 1)) + min;
			}

		}
}
    
</script>
<body>
<h1>Red Hat/SAP IoT Demo</h1>
<div id="body_content">
<canvas id="canvas" width=500px height=300px style="background: url('images/retail.gif'); 	background-size: 500px 300px; background-repeat: no-repeat;">
Your browser does not support HMTL5 canvas.
</canvas>
</div>
</body>
</html>

